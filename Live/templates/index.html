<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Spam Classifier</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .spam { background-color: #ffe6e6; border-left: 4px solid #dc3545; }
        .ham { background-color: #e6f7e6; border-left: 4px solid #28a745; }
        .unread { font-weight: bold; }
        .confidence-bar {
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        .confidence-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
        .navbar-brand { font-weight: bold; }
        .card { box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); }
        .email-preview { cursor: pointer; transition: all 0.2s; }
        .email-preview:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="fas fa-shield-alt"></i> Email Spam Classifier</a>
            <div class="d-flex">
                <span class="navbar-text me-3">
                    <i class="fas fa-envelope"></i> Inbox: <span id="inboxCount">0</span>
                </span>
                <span class="navbar-text">
                    <i class="fas fa-paper-plane"></i> Sent: <span id="sentCount">0</span>
                </span>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Tabs -->
        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="classify-tab" data-bs-toggle="tab" data-bs-target="#classify" type="button">
                    <i class="fas fa-search"></i> Classify Text
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="compose-tab" data-bs-toggle="tab" data-bs-target="#compose" type="button">
                    <i class="fas fa-edit"></i> Compose Email
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="inbox-tab" data-bs-toggle="tab" data-bs-target="#inbox" type="button" onclick="loadInbox()">
                    <i class="fas fa-inbox"></i> Inbox
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="sent-tab" data-bs-toggle="tab" data-bs-target="#sent" type="button" onclick="loadSent()">
                    <i class="fas fa-paper-plane"></i> Sent
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="simulate-tab" data-bs-toggle="tab" data-bs-target="#simulate" type="button">
                    <i class="fas fa-plus"></i> Simulate Receive
                </button>
            </li>
        </ul>

        <div class="tab-content" id="mainTabsContent">
            <!-- Classify Text Tab -->
            <div class="tab-pane fade show active" id="classify" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header">
                        <h5><i class="fas fa-search"></i> Text Classification</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="textInput" class="form-label">Enter email text to classify:</label>
                            <textarea class="form-control" id="textInput" rows="4" 
                                placeholder="Enter the email content here..."></textarea>
                        </div>
                        <div class="mb-3">
                            <button type="button" class="btn btn-primary me-2" onclick="classifyText()">
                                <i class="fas fa-search"></i> Classify
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="loadSampleText()">
                                <i class="fas fa-file-alt"></i> Load Sample
                            </button>
                        </div>
                        
                        <div id="classificationResult" class="mt-4" style="display: none;">
                            <div class="card">
                                <div class="card-body">
                                    <h6>Classification Result:</h6>
                                    <div id="predictionBadge" class="mb-2"></div>
                                    <div class="mb-2">
                                        <small>Confidence:</small>
                                        <div class="confidence-bar">
                                            <div id="confidenceBar" class="confidence-fill"></div>
                                        </div>
                                        <small id="confidenceText"></small>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <small>Spam Probability: <span id="spamProb"></span></small>
                                        </div>
                                        <div class="col-md-6">
                                            <small>Ham Probability: <span id="hamProb"></span></small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Compose Email Tab -->
            <div class="tab-pane fade" id="compose" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header">
                        <h5><i class="fas fa-edit"></i> Compose Email</h5>
                    </div>
                    <div class="card-body">
                        <form id="composeForm">
                            <div class="mb-3">
                                <label for="toEmail" class="form-label">To:</label>
                                <input type="email" class="form-control" id="toEmail" required placeholder="recipient@example.com">
                            </div>
                            <div class="mb-3">
                                <label for="subject" class="form-label">Subject:</label>
                                <input type="text" class="form-control" id="subject" required placeholder="Enter subject">
                            </div>
                            <div class="mb-3">
                                <label for="body" class="form-label">Message:</label>
                                <textarea class="form-control" id="body" rows="6" required placeholder="Enter your message here..."></textarea>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-paper-plane"></i> Send Email
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="clearForm()">
                                    <i class="fas fa-trash"></i> Clear
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Inbox Tab -->
            <div class="tab-pane fade" id="inbox" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-inbox"></i> Inbox</h5>
                        <button class="btn btn-outline-primary btn-sm" onclick="loadInbox()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="inboxList"></div>
                    </div>
                </div>
            </div>

            <!-- Sent Tab -->
            <div class="tab-pane fade" id="sent" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-paper-plane"></i> Sent</h5>
                        <button class="btn btn-outline-primary btn-sm" onclick="loadSent()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="sentList"></div>
                    </div>
                </div>
            </div>

            <!-- Simulate Receive Tab -->
            <div class="tab-pane fade" id="simulate" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header">
                        <h5><i class="fas fa-plus"></i> Simulate Receiving Email</h5>
                    </div>
                    <div class="card-body">
                        <form id="simulateForm">
                            <div class="mb-3">
                                <label for="fromEmail" class="form-label">From:</label>
                                <input type="email" class="form-control" id="fromEmail" required placeholder="sender@example.com">
                            </div>
                            <div class="mb-3">
                                <label for="simSubject" class="form-label">Subject:</label>
                                <input type="text" class="form-control" id="simSubject" required placeholder="Enter subject">
                            </div>
                            <div class="mb-3">
                                <label for="simBody" class="form-label">Message:</label>
                                <textarea class="form-control" id="simBody" rows="6" required placeholder="Enter message content..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-plus"></i> Simulate Receive
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Detail Modal -->
    <div class="modal fade" id="emailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="emailModalTitle">Email Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="emailModalBody">
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Sample texts for demonstration
        const sampleTexts = [
            "Congratulations! You've won $1,000,000! Click here to claim your prize now! Act fast, limited time offer!",
            "Hi John, just wanted to confirm our meeting scheduled for tomorrow at 2 PM. Please let me know if you need to reschedule.",
            "URGENT! Your account will be suspended unless you click this link and verify your information immediately!",
            "The quarterly report is ready for your review. Please find the attached document and let me know if you have any questions."
        ];

        // Load sample text
        function loadSampleText() {
            const randomText = sampleTexts[Math.floor(Math.random() * sampleTexts.length)];
            document.getElementById('textInput').value = randomText;
        }

        // Classify text function
        async function classifyText() {
            const text = document.getElementById('textInput').value;
            if (!text.trim()) {
                alert('Please enter some text to classify');
                return;
            }

            try {
                const response = await fetch('/api/classify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ text: text })
                });

                const result = await response.json();
                if (response.ok) {
                    displayClassificationResult(result);
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Display classification result
        function displayClassificationResult(result) {
            const resultDiv = document.getElementById('classificationResult');
            const predictionBadge = document.getElementById('predictionBadge');
            const confidenceBar = document.getElementById('confidenceBar');
            const confidenceText = document.getElementById('confidenceText');
            const spamProb = document.getElementById('spamProb');
            const hamProb = document.getElementById('hamProb');

            const isSpam = result.prediction === 'Spam';
            const badgeClass = isSpam ? 'badge bg-danger' : 'badge bg-success';
            const barColor = isSpam ? '#dc3545' : '#28a745';

            predictionBadge.innerHTML = `<span class="${badgeClass}">${result.prediction}</span>`;
            confidenceBar.style.width = (result.confidence * 100) + '%';
            confidenceBar.style.backgroundColor = barColor;
            confidenceText.textContent = (result.confidence * 100).toFixed(2) + '%';
            spamProb.textContent = (result.spam_probability * 100).toFixed(2) + '%';
            hamProb.textContent = (result.ham_probability * 100).toFixed(2) + '%';

            resultDiv.style.display = 'block';
        }

        // Clear compose form
        function clearForm() {
            document.getElementById('composeForm').reset();
        }

        // Compose email form
        document.getElementById('composeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                to_email: document.getElementById('toEmail').value,
                subject: document.getElementById('subject').value,
                body: document.getElementById('body').value
            };

            try {
                const response = await fetch('/api/send-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                if (response.ok) {
                    alert('Email sent successfully!');
                    document.getElementById('composeForm').reset();
                    updateEmailCounts();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        // Simulate receive form
        document.getElementById('simulateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                from_email: document.getElementById('fromEmail').value,
                subject: document.getElementById('simSubject').value,
                body: document.getElementById('simBody').value
            };

            try {
                const response = await fetch('/api/simulate-receive', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                if (response.ok) {
                    alert('Email received and classified!');
                    document.getElementById('simulateForm').reset();
                    updateEmailCounts();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        // Load inbox
        async function loadInbox() {
            try {
                const response = await fetch('/api/inbox');
                const result = await response.json();
                
                if (response.ok) {
                    displayEmails(result.emails, 'inboxList', 'inbox');
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Load sent emails
        async function loadSent() {
            try {
                const response = await fetch('/api/sent');
                const result = await response.json();
                
                if (response.ok) {
                    displayEmails(result.emails, 'sentList', 'sent');
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Display emails
        function displayEmails(emails, containerId, type) {
            const container = document.getElementById(containerId);
            
            if (emails.length === 0) {
                container.innerHTML = `<div class="alert alert-info">No ${type} emails found.</div>`;
                return;
            }

            let emailsHtml = '';
            emails.forEach(email => {
                const isSpam = email.classification && email.classification.prediction === 'Spam';
                const cardClass = isSpam ? 'spam' : 'ham';
                const badgeClass = isSpam ? 'badge bg-danger' : 'badge bg-success';
                const unreadClass = (type === 'inbox' && !email.read) ? 'unread' : '';
                
                const fromTo = type === 'inbox' ? `From: ${email.from}` : `To: ${email.to}`;
                
                emailsHtml += `
                    <div class="card mb-3 email-preview ${cardClass}" onclick="showEmailDetail('${email.id}', '${type}')">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <h6 class="card-title ${unreadClass}">${email.subject}</h6>
                                ${email.classification ? `<span class="${badgeClass}">${email.classification.prediction}</span>` : ''}
                            </div>
                            <p class="card-text"><small class="text-muted">${fromTo}</small></p>
                            <p class="card-text">${email.body.substring(0, 100)}${email.body.length > 100 ? '...' : ''}</p>
                            <small class="text-muted">
                                ${email.timestamp}
                                ${email.classification ? ` | Confidence: ${(email.classification.confidence * 100).toFixed(2)}%` : ''}
                            </small>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = emailsHtml;
        }

        // Show email detail
        async function showEmailDetail(emailId, type) {
            // Find the email in the appropriate array
            let email;
            if (type === 'inbox') {
                const response = await fetch('/api/inbox');
                const result = await response.json();
                email = result.emails.find(e => e.id === emailId);
                
                // Mark as read
                if (email && !email.read) {
                    await fetch(`/api/mark-read/${emailId}`, { method: 'POST' });
                    loadInbox(); // Refresh inbox
                }
            } else {
                const response = await fetch('/api/sent');
                const result = await response.json();
                email = result.emails.find(e => e.id === emailId);
            }

            if (email) {
                const modalTitle = document.getElementById('emailModalTitle');
                const modalBody = document.getElementById('emailModalBody');
                
                const isSpam = email.classification && email.classification.prediction === 'Spam';
                const badgeClass = isSpam ? 'badge bg-danger' : 'badge bg-success';
                const fromTo = type === 'inbox' ? `From: ${email.from}` : `To: ${email.to}`;
                
                modalTitle.textContent = email.subject;
                modalBody.innerHTML = `
                    <div class="mb-3">
                        <strong>${fromTo}</strong><br>
                        <small class="text-muted">${email.timestamp}</small>
                        ${email.classification ? `<br><span class="${badgeClass}">${email.classification.prediction}</span>` : ''}
                    </div>
                    <hr>
                    <div class="mb-3">
                        ${email.body.replace(/\n/g, '<br>')}
                    </div>
                    ${email.classification ? `
                    <hr>
                    <div class="row">
                        <div class="col-md-4">
                            <small>Confidence: ${(email.classification.confidence * 100).toFixed(2)}%</small>
                        </div>
                        <div class="col-md-4">
                            <small>Spam: ${(email.classification.spam_probability * 100).toFixed(2)}%</small>
                        </div>
                        <div class="col-md-4">
                            <small>Ham: ${(email.classification.ham_probability * 100).toFixed(2)}%</small>
                        </div>
                    </div>
                    ` : ''}
                `;
                
                new bootstrap.Modal(document.getElementById('emailModal')).show();
            }
        }

        // Update email counts
        async function updateEmailCounts() {
            try {
                const [inboxResponse, sentResponse] = await Promise.all([
                    fetch('/api/inbox'),
                    fetch('/api/sent')
                ]);
                
                const inboxResult = await inboxResponse.json();
                const sentResult = await sentResponse.json();
                
                document.getElementById('inboxCount').textContent = inboxResult.emails ? inboxResult.emails.length : 0;
                document.getElementById('sentCount').textContent = sentResult.emails ? sentResult.emails.length : 0;
            } catch (error) {
                console.error('Error updating email counts:', error);
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            updateEmailCounts();
            loadInbox();
        });

        // Auto-refresh inbox every 30 seconds when on inbox tab
        setInterval(() => {
            const activeTab = document.querySelector('.nav-link.active');
            if (activeTab && activeTab.id === 'inbox-tab') {
                loadInbox();
                updateEmailCounts();
            }
        }, 30000);
    </script>
</body>
</html>